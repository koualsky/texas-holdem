{% extends "game/base.html" %}
{% load game_extras %}

{% block content %}

<nav class="navbar navbar-dark bg-dark p-0 m-0">
{% if user.is_authenticated %}

    <a class="navbar-text text-light pl-3" style="cursor: default;">{{ user }}: <span id="player_money">{{ request.user.player.money }}</span> $</a>
    <div class="btn-group">
        <a href="{% url 'play' %}" class="btn btn-success my-0 my-sm-0">Refresh</a>
        <a href="{% url 'exit' %}" class="btn btn-danger my-0 my-sm-0">Exit game</a>
    </div>

{% endif %}
</nav>

<!-- POOL -->
<h3 class="text-center text-secondary pb-2 pt-3">Pool: <span id="pool">{{ table.pool }}</span> $</h3>

<!-- 1. ALL PLAY SCREEN: BOARD AND PLAYERS CARDS -->
<div class="container p-0 border border-top-0 rounded" style="max-width: 320px;">

<!-- GAME TABLE (table-bordered) -->
<table class="table container p-0 m-0" style="cursor: default;">
  <tbody>

    <!-- BOARD -->
    <tr>
        <td colspan="2" class="align-middle text-right p-0">Board</td>
        <td colspan="3" class="align-middle text-left p-0"><span class="d-flex" id="board_cards" style="cursor: default;">{{ table.print_pretty_cards_on_table }}</span></td>
    </tr>

    <!-- PLAYERS -->
    {% for player in players_list %}

        <!-- IN GAME -->
        {% if player.state != 'out' %}

        <!-- Backlight for winner -->
        {% if table.the_winner == player %}
        <tr style="background-color: red;">
        {% else %}
        <tr>
        {% endif %}

          <!-- DEALER -->
          <td class="align-middle text-center p-0" style="width: 40px;">
              {% if table.game_state != 'ready' and table.dealer == player %} <span class="badge badge-pill badge-danger">D</span> {% endif %}
              {% if table.game_state != 'ready' and table.small_blind == player %} <span class="badge badge-pill badge-warning">S</span> {% endif %}
              {% if table.game_state != 'ready' and table.big_blind == player %} <span class="badge badge-pill badge-warning">B</span> {% endif %}
          </td>

          <!-- NAME & MONEY -->
          <td class="align-middle text-right p-0" style="width: 100px; max-width: 100px;">
              {% if player == request.user.player %}<b>{{ player }}</b>{% else %}{{ player }}{% endif %}<br /><sup class="text-muted">{{ player.money }} $</sup>
          </td>

          <!-- CARDS -->
          <td class="align-middle text-left p-0 d-flex align-items-center">
                <!-- Player can see only itself cards -->
                {% if request.user.player == player or table.game_state == 'winner' %}
                    <span class="d-flex" id="player_cards_{{ forloop.counter }}">{{ player.print_pretty_cards_cards }}</span>
                    {{ player.my_hand }}
                    {% elif player.cards != None %}
                    <span class="d-flex">
                        <div class="card text-white bg-dark container-fluid m-1" style="width: 2rem; height: 3rem;"></div>
                        <div class="card text-white bg-dark container-fluid m-1" style="width: 2rem; height: 3rem;"></div>
                    </span>
                {% endif %}
          </td>

          <!-- RATE -->
          <td class="align-middle text-center p-0" style="width: 40px;">{{ player.round_money }}</td>

          <!-- STATE -->
          <td class="align-middle text-center p-0" style="width: 50px;">
              <!-- STATE -->
              <!-- Show who turn is now -->
              {% if table.decission == player %}
                {% if request.user.player != player %}
                    <!-- BEFORE: ( ! ) -->
                    <div class="spinner-grow spinner-grow-sm" role="status">
                        <span class="sr-only">( ! )</span>
                    </div>
                {% endif %}
              <!-- If you aren't you, show him status -->
              {% else %}
                {% if player.state != 'start' %}
                    {{ player.state }}
                {% endif %}
              {% endif %}
          </td>
        </tr>

        <!-- OUT OF GAME -->
        {% else %}

        <tr style="color: #d9d9d9;">

          <!-- DEALER -->
          <td class="align-middle text-center p-0" style="width: 40px;">
              {% if table.game_state != 'ready' and table.dealer == player %} D {% endif %}
              {% if table.game_state != 'ready' and table.small_blind == player %} s {% endif %}
              {% if table.game_state != 'ready' and table.big_blind == player %} b {% endif %}
          </td>

          <!-- NAME & MONEY -->
          <td class="align-middle text-right p-0" style="width: 100px; max-width: 100px;">
              {{ player }}<br /><sup>{{ player.money }} $</sup>
          </td>

          <!-- CARDS -->
          <td class="align-middle text-left p-0 d-flex align-items-center" style="cursor: default;"></td>

          <!-- RATE -->
          <td class="align-middle text-center p-0" style="width: 40px;"></td>

          <!-- STATE -->
          <td class="align-middle text-left p-0" style="width: 50px;">{{ player.state }}</td>
        </tr>
        {% endif %}
    {% endfor %}
  </tbody>
</table>
</div>

















<!-- 2. DECISSION IF YOUR'S TURN -->
<div class="container-fluid fixed-bottom text-center mb-3" style="max-width: 414px;">
{% for player in players_list %}

    <!-- CHECK / CALL / RAISE -->
    {% if request.user.player.table.game_state != 'winner' %}
        {% if request.user.player == player and table.decission == player %}

            <form action="/raise/" method="POST" class="float-none d-inline text-center">{% csrf_token %}

                <div class="form-group p-1 text-center">

                    <div class="input-group mb-3 text-center">
                        <input class="form-control text-center" id="how_much" name="how_much" type="number" value="{{ table.biggest_rate|subtract:request.user.player.round_money }}" min="{{ table.biggest_rate|subtract:request.user.player.round_money }}" max="{{ request.user.player.money }}">
                        <div class="input-group-append">
                            <span class="input-group-text" id="basic-addon2">$</span>
                        </div>
                    </div>


                    <input type="range" class="custom-range form-control-range" min="{{ table.biggest_rate|subtract:request.user.player.round_money }}" max="{{ request.user.player.money }}" value="{{ table.biggest_rate|subtract:request.user.player.round_money }}" id="formControlRange">
                </div>

                <!-- 1. Span is for JS functionality -->
                <span id="raise_button"></span>
            </form>

            <!-- 2. Span is for JS functionality -->
            <span id="check_call_buttons">
            <!-- This button shows when all players have the same round_money -->
            {% if request.user.player.round_money == table.biggest_rate %}
                <a href="{% url 'check' %}" class="btn btn-lg btn-success">check</a>
                <!-- This button shows when you have to add to game pool  -->
            {% else %}
                <a href="{% url 'check' %}" class="btn btn-lg btn-success">call</a>
            {% endif %}
            </span>

        {% endif %}
    {% endif %}

    <!-- PASS -->
    {% if request.user.player.table.game_state != 'winner' %}
        {% if request.user.player == player and table.decission == player %}
            <a href="{% url 'pass' %}" class="btn btn-lg btn-danger">pass</a>
        {% endif %}
    {% endif %}
{% endfor %}
</div>






<!-- Hide line below until game state achieve 'winner' state -->
{% if request.user.player.table.game_state == 'winner' %}

<!-- Modal -->
<div id="myModal" class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">

      <div class="modal-body text-center">
          The winner is <strong>{{ table.the_winner }}</strong> with <strong>{{ table.the_winner.my_hand }}</strong>
      </div>
      <div class="modal-footer text-center">
        <button type="button" class="btn btn-danger btn-lg" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script type="text/javascript">
    $(window).on('load', function(){
        $('#myModal').modal('show')
    });
</script>

<div class="text-center p-4">
    <a href="{% url 'check' %}" class="btn btn-success btn-lg my-0 my-sm-0">Play again</a>
</div>

{% endif %}

{% endblock %}

